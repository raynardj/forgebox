---

title: Bert Visualize

keywords: fastai
sidebar: home_sidebar

summary: "Visualize masked language modeling transformer model"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/bert_visualize.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    {% raw %}
        
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># !pip install transformers</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoModelForMaskedLM</span><span class="p">,</span><span class="n">AutoTokenizer</span>
<span class="kn">from</span> <span class="nn">forgebox.imports</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">forgebox.config</span> <span class="kn">import</span> <span class="n">Config</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForMaskedLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;bert-base-uncased&quot;</span><span class="p">)</span>
<span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;bert-base-uncased&quot;</span><span class="p">,</span><span class="n">use_fast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A piece of sample text</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;I must not [MASK].</span>
<span class="s2">Fear is the mind-killer.</span>
<span class="s2">Fear is the little [MASK] that brings total obliteration.</span>
<span class="s2">I will face my fear.</span>
<span class="s2">I will permit it to pass over me and through me.</span>
<span class="s2">And when it has gone past I will turn the inner [MASK] to see its path.</span>
<span class="s2">Where the fear has gone there will be nothing.</span>
<span class="s2">Only I will remain.&quot;&quot;&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">MLMVisualizer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">tokenizer</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
        
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_pretrained</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
                        <span class="n">tag</span><span class="p">:</span><span class="s2">&quot;str, like how you use from_pretrained from transformers&quot;</span>
                       <span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForMaskedLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">tag</span><span class="p">),</span>
                <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">use_fast</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>
        
    <span class="k">def</span> <span class="nf">tok</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">text</span><span class="p">:</span><span class="nb">str</span><span class="p">,)</span><span class="o">-&gt;</span><span class="p">[</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">BoolTensor</span><span class="p">,</span>
            <span class="nb">list</span><span class="p">,</span>
        <span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A specific way of tokenizing.</span>
<span class="sd">            with pytorch tensor as input</span>
<span class="sd">            with mask tensor specifying where&#39;s the [MASK] token</span>
<span class="sd">            with offset mapping marking the positions </span>
<span class="sd">                in format of list in list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tokenized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span>
            <span class="n">text</span><span class="p">,</span>
            <span class="n">return_tensors</span> <span class="o">=</span> <span class="s2">&quot;pt&quot;</span><span class="p">,</span>
            <span class="n">return_offsets_mapping</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">tokenized</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span>
        <span class="n">offset_mapping</span> <span class="o">=</span> <span class="n">tokenized</span><span class="p">[</span><span class="s1">&#39;offset_mapping&#39;</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">x</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">mask_token_id</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">mask</span><span class="p">,</span><span class="n">offset_mapping</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vis</span> <span class="o">=</span> <span class="n">MLMVisualizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;bert-base-uncased&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">li</span><span class="p">(</span><span class="n">x</span><span class="p">,)</span><span class="o">-&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">infer_logits</span><span class="p">(</span>
        <span class="n">vis</span><span class="p">,</span>
        <span class="n">y_pred</span><span class="p">,</span>
        <span class="n">mask</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Config</span><span class="p">:</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
    <span class="n">pred_idx</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Config</span><span class="p">(</span>
        <span class="n">logits</span><span class="o">=</span><span class="n">logits</span><span class="p">,</span>
        <span class="n">pred_idx</span><span class="o">=</span><span class="n">pred_idx</span><span class="p">,</span>
        <span class="n">pred_tokens</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">convert_ids_to_tokens</span><span class="p">(</span><span class="n">pred_idx</span><span class="p">)</span>
    <span class="p">)</span>


<span class="n">MLMVisualizer</span><span class="o">.</span><span class="n">infer_logits</span> <span class="o">=</span> <span class="n">infer_logits</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">predict_text</span><span class="p">(</span>
        <span class="n">vis</span><span class="p">,</span>
        <span class="n">text</span><span class="p">,</span>
           <span class="p">)</span><span class="o">-&gt;</span><span class="n">Config</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">x</span><span class="p">,</span><span class="n">mask</span><span class="p">,</span><span class="n">mapper</span><span class="o">=</span><span class="n">vis</span><span class="o">.</span><span class="n">tok</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">y_pred</span><span class="p">,</span><span class="n">attention</span> <span class="o">=</span> <span class="n">vis</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">output_attentions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">infered</span> <span class="o">=</span> <span class="n">vis</span><span class="o">.</span><span class="n">infer_logits</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Config</span><span class="p">(</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">,</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">li</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">li</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="n">li</span><span class="p">(</span><span class="n">mapper</span><span class="p">),</span>
<span class="c1">#         y_pred = li(y_pred),</span>
<span class="c1">#         logits = li(infered.logits),</span>
        <span class="n">pred_idx</span><span class="o">=</span><span class="n">li</span><span class="p">(</span><span class="n">infered</span><span class="o">.</span><span class="n">pred_idx</span><span class="p">),</span>
        <span class="n">pred_tokens</span> <span class="o">=</span><span class="n">infered</span><span class="o">.</span><span class="n">pred_tokens</span><span class="p">,</span>
        <span class="n">attention</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">li</span><span class="p">,</span><span class="n">attention</span><span class="p">)),</span>
    <span class="p">)</span>
<span class="n">MLMVisualizer</span><span class="o">.</span><span class="n">predict_text</span> <span class="o">=</span> <span class="n">predict_text</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">Template</span>
<span class="kn">from</span> <span class="nn">forgebox.html</span> <span class="kn">import</span> <span class="n">DOM</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">visualize</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span>
              <span class="n">text</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">vis</span><span class="o">.</span><span class="n">predict_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">vis</span><span class="o">.</span><span class="n">visualize_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">visualize_result</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">Config</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;mlm_visual.html&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;mlm_visual.js&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">js</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">text</span>
    <span class="nb">delattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span>
    <span class="n">output_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">),</span>
                           <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
                           <span class="n">output_id</span><span class="o">=</span><span class="n">output_id</span><span class="p">,</span>
                           <span class="n">mlm_visual_js</span><span class="o">=</span><span class="n">js</span><span class="p">)</span>
    <span class="n">DOM</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;div&quot;</span><span class="p">,)()</span>


<span class="n">MLMVisualizer</span><span class="o">.</span><span class="n">visualize</span> <span class="o">=</span> <span class="n">visualize</span>
<span class="n">MLMVisualizer</span><span class="o">.</span><span class="n">visualize_result</span> <span class="o">=</span> <span class="n">visualize_result</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">softmax</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">predict_text</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span><span class="n">text</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">vis</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}
</div>
 

